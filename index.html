<!DOCTYPE html>
<html>
<head>
    <title>DMOJ local judge</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <!--WTF? Must load twice to work-->
    <script src="js/jquery.min.js"></script>
    <script src="js/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="ace/ace.js" type="text/javascript" charset="utf-8"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0
        }

        body {
            display: flex;
            flex-flow: column;
            height: 100%;
        }

        main {
            flex: 1;
            overflow-y: auto;
            position: relative;
        }

        #home-panel, #queue-panel, #problem-detail {
            display: none;
        }

        .tab-panel {
            margin: 1em 1em 0 1em;
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
        }

        .editor { 
            position: absolute;
            bottom: 1em;
            top: 70px;
            left: 0;
            right: 0;
        }

        #loading {
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.25);
            z-index: 1000;
        }

        #loading div {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: url('img/load.svg');
            background-size: 100% auto;
            width: 50vmin;
            height: 50vmin;
        }
    </style>
    <script type="text/javascript">
        var ipc = require('ipc');
        var problem_count = 0;

        ipc.on('problem-list', function (data) {
            for (var i in data) {
                $('#problem-list-body').append('<tr><td style="width:100%;vertical-align:middle">' +
                        data[i] +
                        '</td><td><button type="button" class="btn btn-default problem-detail"><span class="glyphicon glyphicon-menu-right" aria-hidden="true"></span></button></td></tr>');
            }
            problem_count += data.length;
        }).on('problem-list-done', function (data) {
            $('#loading').fadeOut(500);
            $('#problem-count-badge').text(problem_count);
            $('.problem-detail').click(function () {
                var code = $(this).parents('tr').find('td:first-child').text();
                var page = $('#problem-detail');
                page.find('h1').text(code);
                ipc.send('query-problem-data', code);
                switch_tab(page);
            });
        }).on('problem-data', function (data) {
            $('#problem-data').text(data);
        });
        $(document).ready(function () {
            window.current_tab = $('#problem-panel');
            window.current_label = $('#problem-tab').addClass('active');
            window.switch_tab = function (new_tab, label) {
                window.current_tab.hide();
                window.current_tab = new_tab.show();
                if (label) {
                    window.current_label.removeClass('active');
                    window.current_label = label.addClass('active');
                }
            };

            $('#home-tab').click(function () {
                switch_tab($('#home-panel'), $('#home-tab'));
            });
            $('#problem-tab').click(function () {
                switch_tab($('#problem-panel'), $('#problem-tab'));
            });
            $('#queue-tab').click(function () {
                switch_tab($('#queue-panel'), $('#queue-tab'));
            });
            $('#reload-problems').click(function () {
                $('#problem-list-body').empty();
                problem_count = 0;
                ipc.send('load-problems');
                $('#loading').fadeIn(500);
            });
            $('#filter').keyup(function () {
                var rex = new RegExp($(this).val(), 'i');
                $('.searchable tr').hide().filter(function () {
                    return rex.test($(this).text());
                }).show();
            });
            $('#problem-submit').click(function () {
                var code = $('#problem-detail').find('h1').text();
                var panel = $('<div class="tab-panel submission-panel"/>')
                    .append('<h1>Submit ' + code + '</h1>')
                    .append($('<div class="editor"/>').text('function foo(items) {\n    var x = "All this is syntax highlighted";\n    return x;\n}')).appendTo('main');
                var editor = ace.edit(panel.find('.editor').get(0));
                editor.setTheme('ace/theme/monokai');
                editor.getSession().setMode('ace/mode/javascript');
                var tab = $('<li/>', {id: 'submit-' + code, role: 'presentation'})
                    .append($('<a/>', {href: '#'}).text(code)
                        .prepend('<span class="glyphicon glyphicon-pencil"/>')
                        .append($('<span class="glyphicon glyphicon-remove"/></span>').click(function () {
                            tab.remove();
                            panel.remove();
                            if (current_label == tab)
                                switch_tab($('#problem-panel'), $('#problem-tab'));
                        })))
                    .click(function () {
                        switch_tab(panel, tab);
                    }).appendTo($('.nav-tabs'));
                switch_tab(panel, tab);
            });
            ipc.send('load-problems');
        });
    </script>
</head>
<body>
<nav>
<ul class="nav nav-tabs" role="tablist">
    <li id="home-tab" role="presentation"><a href="#">Home</a></li>
    <li id="problem-tab" role="presentation" class="active"><a href="#">Problems <span id="problem-count-badge"
                                                                                       class="badge"></span></a></li>
    <li id="queue-tab" role="presentation"><a href="#">Queue <span class="badge">667</span></a></li>
</ul>
</nav>

<main>
<div id="loading"><div></div></div>

<div id="problem-panel" class="tab-panel">
    <div class="container">
        <div class="panel panel-primary">
            <div class="panel-heading">Problems <button type="button" class="btn btn-default btn-xs pull-right">
                <span id="reload-problems" class="glyphicon glyphicon-refresh"></span></button></div>
            <div class="panel-body">
                <div class="input-group">
                <span class="input-group-addon" id="sizing-addon1">
                    <span class="glyphicon glyphicon-search" aria-hidden="true"></span>
                </span>
                    <input id="filter" type="text" class="form-control" placeholder="Search problems..."
                           aria-describedby="sizing-addon1">
                </div>
            </div>
            <table class="table table-hover table-striped header-fixed">
                <thead>
                <tr>
                    <th>Code</th>
                    <th></th>
                </tr>
                </thead>
                <tbody id="problem-list-body" class="searchable">
                </tbody>
            </table>
        </div>
    </div>
</div>

<div id="home-panel" class="tab-panel">
    <div class="container">
        <div class="jumbotron">
            <h1>Hello, world!</h1>

            <p>...</p>

            <p><a class="btn btn-primary btn-lg" href="#" role="button">Start judging</a></p>
        </div>
    </div>
</div>

<div id="queue-panel" class="tab-panel">
    <h1>TODO</h1>
</div>

<div id="problem-detail" class="tab-panel">
    <h1></h1>
    <button id="problem-submit" type="button" class="btn btn-default">
        <span class="glyphicon glyphicon-pencil"></span>
        Submit
    </button>
    <br>
    <pre id="problem-data"></pre>
</div>
</main>
</body>
</html>